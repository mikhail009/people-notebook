<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>{{ (p.first_name or '') ~ ' ' ~ (p.last_name or '') }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#f6fbff; --card:#fff; --text:#0b1b20; --muted:#6b7a80;
      --primary:#1dd3b0; --primary-2:#2e7de9; --border:#e8eef4; --ring: rgba(46,125,233,.35);
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font:15px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    header.hero{
      padding:44px 24px 72px;
      background: radial-gradient(1200px 500px at 20% 0%, rgba(255,255,255,.25), transparent 60%),
                  linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);
      color:#fff; position: relative; box-shadow: inset 0 -1px rgba(0,0,0,.08);
    }
    .wrap{ max-width: 1000px; margin: 0 auto; padding: 0 24px 40px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 12px 24px rgba(0,0,0,.06); }
    section{ margin: 18px 0; }
    h2{margin:0}
    .avatar{
      width:96px; height:96px; border-radius:999px; object-fit:cover; border:4px solid rgba(255,255,255,.9);
      background:linear-gradient(135deg,#dffaf3,#e6f0ff); display:flex; align-items:center; justify-content:center; font-weight:800; color:#234; letter-spacing:.5px;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .hero-card{
      position:relative; top:-56px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px;
      display:flex; gap:16px; align-items:center; box-shadow:0 18px 34px rgba(0,0,0,.18);
    }
    .muted{ color:var(--muted) }
    .grid{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .chip{ display:inline-block; padding:6px 10px; border-radius:999px; background:#eef6ff; color:#1b3b6b; font-weight:600; border:1px solid #dbe6ff; }
    details summary{ cursor:pointer }
    ul.pets{ list-style:none; padding:0; margin:0 }
    .pet{ border:1px solid var(--border); border-radius:14px; padding:10px; margin:10px 0; background:#fff; }
    .pet-thumb{ width:56px; height:56px; border-radius:12px; background:#eef5ff; display:inline-flex; align-items:center; justify-content:center; margin-right:8px; }
    input, textarea, select{ border:1px solid var(--border); border-radius:12px; padding:8px 10px; width:100%; outline:none }
    input:focus, textarea:focus, select:focus{ border-color:var(--primary-2); box-shadow: 0 0 0 4px var(--ring); }
    button{ border:0; border-radius:12px; padding:10px 14px; background:linear-gradient(135deg, var(--primary), var(--primary-2)); color:#fff; cursor:pointer; box-shadow:0 10px 20px rgba(46,125,233,.2); }
    .secondary{ background:#eef5ff; color:#1b3b6b }
    img.pet-photo{ max-width:160px; border-radius:10px; display:block }
    .top-links a{ color:#fff; opacity:.9; text-decoration:none }
    .actions-row{ display:flex; gap:10px; flex-wrap:wrap; }
    a.link{ color: var(--primary-2); text-decoration: none; }
  </style>
</head>
<body data-page="detail-v3">

<header class="hero">
  <div class="wrap">
    <div class="top-links"><a href="/">‚Üê –∫–æ —Å–ø–∏—Å–∫—É</a></div>
    <h2>{{ p.first_name or '' }} {{ p.last_name or '' }}</h2>
  </div>
</header>

<div class="wrap">
  <div class="hero-card">
    {% set initials = ((p.first_name[0] if p.first_name else '') + (p.last_name[0] if p.last_name else '')).upper() %}
    {% if p.avatar_path %}
      <img class="avatar" src="{{ p.avatar_path }}" alt="">
    {% else %}
      <div class="avatar">{{ initials or 'üë§' }}</div>
    {% endif %}
    <div style="flex:1">
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        {% if p.city %}<span class="chip">üìç {{ p.city }}</span>{% endif %}
        {% if p.phone %}<span class="chip">üìû {{ p.phone }}</span>{% endif %}
        {% if p.email %}<span class="chip">‚úâÔ∏è {{ p.email }}</span>{% endif %}
      </div>
      {% if p.birth_day or p.birth_month or p.birth_year %}
        <div class="muted" style="margin-top:6px">
          üéÇ
          {% if p.birth_day %}{{ "%02d"|format(p.birth_day) }}.{% else %}??.{% endif %}
          {% if p.birth_month %}{{ "%02d"|format(p.birth_month) }}{% else %}??{% endif %}
          {% if p.birth_year %} {{ p.birth_year }}{% endif %}
          {% set age = calc_age(p.birth_day, p.birth_month, p.birth_year) %}
          {% if age is not none %} ‚Ä¢ {{ age }} –ª–µ—Ç{% endif %}
        </div>
      {% endif %}
      {% if address_full %}
        <div class="muted" style="margin-top:6px">
          üè† –ê–¥—Ä–µ—Å:
          <a class="link" target="_blank" rel="noopener" href="{{ yandex_maps_url(address_full) }}">{{ address_full }}</a>
        </div>
      {% endif %}
    </div>
    <div class="actions-row">
      <a class="secondary" href="/person/{{ p.id }}/edit" style="padding:10px 14px; border-radius:12px; text-decoration:none;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
      <form method="post" action="/person/{{ p.id }}/delete" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞ –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')">
        <button style="background:#ff3b30;">–£–¥–∞–ª–∏—Ç—å</button>
      </form>
    </div>
  </div>

  <!-- –†–∞–±–æ—Ç–∞ -->
  <section>
    <h4>üíº –†–∞–±–æ—Ç–∞</h4>
    {% if p.workplace or p.job_title %}
      <div class="card">
        {% if p.workplace %}<div><strong>–ì–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> {{ p.workplace }}</div>{% endif %}
        {% if p.job_title %}<div><strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> {{ p.job_title }}</div>{% endif %}
      </div>
    {% else %}
      <div class="card muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ.</div>
    {% endif %}
  </section>

  <!-- –°–µ–º—å—è -->
  <section>
    <h4>üíç –°–µ–º—å—è</h4>
    {% if p.marital_status or p.partner_name %}
      <div class="card">
        {% if p.marital_status %}
          <div><strong>–°—Ç–∞—Ç—É—Å:</strong>
            {% if p.marital_status=='single' %}–û–¥–∏–Ω–æ–∫(–∞){% endif %}
            {% if p.marital_status=='married' %}–ñ–µ–Ω–∞—Ç(–∞){% endif %}
            {% if p.marital_status=='partnered' %}–ï—Å—Ç—å –≤—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∫–∞{% endif %}
          </div>
        {% endif %}
        {% if p.partner_name %}<div><strong>–ü–∞—Ä—Ç–Ω—ë—Ä:</strong> {{ p.partner_name }}</div>{% endif %}
      </div>
    {% else %}
      <div class="card muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ.</div>
    {% endif %}
  </section>

  <!-- –õ–∏—á–Ω–æ–µ -->
  <section>
    <h4>üß† –õ–∏—á–Ω–æ–µ</h4>
    {% if p.handedness or p.smokes is not none %}
      <div class="card">
        {% if p.handedness %}
          <div><strong>–†—É–∫–∞:</strong>
            {% if p.handedness=='right' %}–ü—Ä–∞–≤—à–∞{% elif p.handedness=='left' %}–õ–µ–≤—à–∞{% else %}–ê–º–±–∏–¥–µ–∫—Å—Ç—Ä{% endif %}
          </div>
        {% endif %}
        {% if p.smokes is not none %}
          <div><strong>–ö—É—Ä–∏—Ç:</strong> {{ '–î–∞' if p.smokes else '–ù–µ—Ç' }}</div>
        {% endif %}
      </div>
    {% else %}
      <div class="card muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ.</div>
    {% endif %}
  </section>

  <!-- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è -->
  <section>
    <h4>üçΩÔ∏è –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</h4>
    {% if p.food_prefs or p.alcohol_prefs or p.places_to_go %}
      <div class="card">
        {% if p.food_prefs %}<div><strong>–ï–¥–∞:</strong> {{ p.food_prefs|replace('\n','<br>')|safe }}</div>{% endif %}
        {% if p.alcohol_prefs %}<div><strong>–ê–ª–∫–æ–≥–æ–ª—å:</strong> {{ p.alcohol_prefs|replace('\n','<br>')|safe }}</div>{% endif %}
        {% if p.places_to_go %}<div><strong>–ö—É–¥–∞ —Å—Ö–æ–¥–∏—Ç—å/–ø–æ–≥—É–ª—è—Ç—å:</strong> {{ p.places_to_go|replace('\n','<br>')|safe }}</div>{% endif %}
      </div>
    {% else %}
      <div class="card muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ.</div>
    {% endif %}
  </section>

  <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä -->
  <section>
    <h4>üåü –•–∞—Ä–∞–∫—Ç–µ—Ä</h4>
    {% if p.traits_positive or p.traits_negative %}
      <div class="card">
        {% if p.traits_positive %}<div><strong>–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞:</strong><br>{{ p.traits_positive|replace('\n','<br>')|safe }}</div>{% endif %}
        {% if p.traits_negative %}<div style="margin-top:8px"><strong>–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞:</strong><br>{{ p.traits_negative|replace('\n','<br>')|safe }}</div>{% endif %}
      </div>
    {% else %}
      <div class="card muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ.</div>
    {% endif %}
  </section>

  <!-- –ü–æ–∂–µ–ª–∞–Ω–∏—è –Ω–∞ –î–† -->
  <section>
    <h4>üéÅ –ß—Ç–æ —Ö–æ—Ç–µ–ª(–∞) –Ω–∞ –î–†</h4>
    {% if p.wishlist %}
      <div class="card">{{ p.wishlist|replace('\n','<br>')|safe }}</div>
    {% else %}
      <div class="card muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ.</div>
    {% endif %}
  </section>

  <!-- –°–æ—Ü—Å–µ—Ç–∏ -->
  <section>
    <h4>üåê –°–æ—Ü—Å–µ—Ç–∏</h4>
    {% if p.telegram_username or p.instagram_username or p.vk_username %}
      <div class="card">
        {% if p.telegram_username %}
          <div><strong>Telegram:</strong> <a class="link" target="_blank" rel="noopener" href="https://t.me/{{ p.telegram_username }}">@{{ p.telegram_username }}</a></div>
        {% endif %}
        {% if p.instagram_username %}
          <div><strong>Instagram:</strong> <a class="link" target="_blank" rel="noopener" href="https://instagram.com/{{ p.instagram_username }}">@{{ p.instagram_username }}</a></div>
        {% endif %}
        {% if p.vk_username %}
          <div><strong>VK:</strong> <a class="link" target="_blank" rel="noopener" href="https://vk.com/{{ p.vk_username }}">@{{ p.vk_username }}</a></div>
        {% endif %}
      </div>
    {% else %}
      <div class="card muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ.</div>
    {% endif %}
  </section>

  <!-- –î–æ–º–∞—à–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã–µ -->
  <section>
    <h4>üêæ –î–æ–º–∞—à–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã–µ</h4>
    <details>
      <summary>+ –î–æ–±–∞–≤–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞</summary>
      <div class="card" style="margin-top:10px">
        <form method="post" action="/person/{{ p.id }}/pets/new" enctype="multipart/form-data">
          <div class="grid">
            <label>–ö–ª–∏—á–∫–∞ <input name="name" required></label>
            <label>–í–∏–¥ <input name="species" required placeholder="–∫–æ—à–∫–∞, —Å–æ–±–∞–∫–∞..."></label>
            <label>–ü–æ—Ä–æ–¥–∞ <input name="breed"></label>
            <label>–í–æ–∑—Ä–∞—Å—Ç <input name="age"></label>
            <label>–ü–æ–ª <input name="sex"></label>
          </div>
          <label>–ö–æ—Ä–º–ª–µ–Ω–∏–µ <textarea name="feeding" rows="2"></textarea></label>
          <label>–£—Ö–æ–¥ <textarea name="care" rows="2"></textarea></label>
          <label>–ó–∞–º–µ—Ç–∫–∏ <textarea name="notes" rows="2"></textarea></label>
          <label>–§–æ—Ç–æ <input type="file" name="photo" accept="image/*"></label>
          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
      </div>
    </details>

    {% if pets and pets|length %}
      <ul class="pets">
        {% for pet in pets %}
          <li class="pet">
            <details>
              <summary>
                {% if pet.photo_path %}<img class="pet-photo" src="{{ pet.photo_path }}" alt="">{% else %}
                  <span class="pet-thumb">üêæ</span>
                {% endif %}
                <strong>{{ pet.name }}</strong> ‚Äî {{ pet.species }}
              </summary>
              <div style="margin-top:8px">
                <div class="grid">
                  {% if pet.breed %}<div>–ü–æ—Ä–æ–¥–∞: {{ pet.breed }}</div>{% endif %}
                  {% if pet.age %}<div>–í–æ–∑—Ä–∞—Å—Ç: {{ pet.age }}</div>{% endif %}
                  {% if pet.sex %}<div>–ü–æ–ª: {{ pet.sex }}</div>{% endif %}
                </div>
                {% if pet.feeding %}<p><strong>–ö–æ—Ä–º–ª–µ–Ω–∏–µ:</strong><br>{{ pet.feeding|replace('\n','<br>')|safe }}</p>{% endif %}
                {% if pet.care %}<p><strong>–£—Ö–æ–¥:</strong><br>{{ pet.care|replace('\n','<br>')|safe }}</p>{% endif %}
                {% if pet.notes %}<p><strong>–ó–∞–º–µ—Ç–∫–∏:</strong><br>{{ pet.notes|replace('\n','<br>')|safe }}</p>{% endif %}

                <form method="post" action="/pets/{{ pet.id }}/edit" enctype="multipart/form-data" style="margin-top:8px">
                  <h6>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h6>
                  <div class="grid">
                    <label>–ö–ª–∏—á–∫–∞ <input name="name" value="{{ pet.name }}" required></label>
                    <label>–í–∏–¥ <input name="species" value="{{ pet.species }}" required></label>
                    <label>–ü–æ—Ä–æ–¥–∞ <input name="breed" value="{{ pet.breed or '' }}"></label>
                    <label>–í–æ–∑—Ä–∞—Å—Ç <input name="age" value="{{ pet.age or '' }}"></label>
                    <label>–ü–æ–ª <input name="sex" value="{{ pet.sex or '' }}"></label>
                  </div>
                  <label>–ö–æ—Ä–º–ª–µ–Ω–∏–µ <textarea name="feeding" rows="2">{{ pet.feeding or '' }}</textarea></label>
                  <label>–£—Ö–æ–¥ <textarea name="care" rows="2">{{ pet.care or '' }}"></textarea></label>
                  <label>–ó–∞–º–µ—Ç–∫–∏ <textarea name="notes" rows="2">{{ pet.notes or '' }}"></textarea></label>
                  <label>–§–æ—Ç–æ <input type="file" name="photo" accept="image/*"></label>

                  <div class="actions-row" style="margin-top:8px">
                    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="secondary" type="submit" formmethod="post" formaction="/pets/{{ pet.id }}/delete" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞?')">–£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                </form>
              </div>
            </details>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="card muted">–ü–∏—Ç–æ–º—Ü–µ–≤ –Ω–µ—Ç.</div>
    {% endif %}
  </section>

  <!-- –î–µ—Ç–∏ -->
  <section>
    <h4>üë∂ –î–µ—Ç–∏</h4>
    <details>
      <summary>+ –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞</summary>
      <div class="card" style="margin-top:10px">
        <form method="post" action="/person/{{ p.id }}/children/new">
          <div class="grid">
            <label>–ò–º—è <input name="name" required></label>
            <label>–î–µ–Ω—å <input type="number" min="1" max="31" name="birth_day"></label>
            <label>–ú–µ—Å—è—Ü <input type="number" min="1" max="12" name="birth_month"></label>
            <label>–ì–æ–¥ <input type="number" min="1900" max="2100" name="birth_year"></label>
          </div>
          <div class="grid">
            <label>–ü–æ–ª <input name="sex" placeholder="–º/–∂/–¥—Ä—É–≥–æ–µ"></label>
          </div>
          <label>–ó–∞–º–µ—Ç–∫–∏ <textarea name="notes" rows="2"></textarea></label>
          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
      </div>
    </details>

    {% if children and children|length %}
      <ul class="pets">
        {% for c in children %}
          <li class="pet">
            <details>
              <summary>
                <span class="pet-thumb">üë∂</span>
                <strong>{{ c.name }}</strong>
                {% set a = calc_age(c.birth_day, c.birth_month, c.birth_year) %}
                {% if a is not none %} ‚Äî {{ a }} –ª–µ—Ç{% endif %}
              </summary>
              <div class="pet-body" style="margin-top:8px">
                <div class="grid">
                  {% if c.birth_day or c.birth_month or c.birth_year %}
                    <div>üéÇ –î–†:
                      {% if c.birth_day %}{{ "%02d"|format(c.birth_day) }}.{% else %}??.{% endif %}
                      {% if c.birth_month %}{{ "%02d"|format(c.birth_month) }}{% else %}??{% endif %}
                      {% if c.birth_year %} {{ c.birth_year }}{% endif %}
                    </div>
                  {% endif %}
                  {% if c.sex %}<div>‚öß –ü–æ–ª: {{ c.sex }}</div>{% endif %}
                </div>
                {% if c.notes %}<p class="note-body">{{ c.notes | replace('\n','<br>') | safe }}</p>{% endif %}

                <form method="post" action="/children/{{ c.id }}/edit" style="margin-top:8px">
                  <h6>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h6>
                  <div class="grid">
                    <label>–ò–º—è <input name="name" value="{{ c.name }}" required></label>
                    <label>–î–µ–Ω—å <input type="number" min="1" max="31" name="birth_day" value="{{ c.birth_day or '' }}"></label>
                    <label>–ú–µ—Å—è—Ü <input type="number" min="1" max="12" name="birth_month" value="{{ c.birth_month or '' }}"></label>
                    <label>–ì–æ–¥ <input type="number" min="1900" max="2100" name="birth_year" value="{{ c.birth_year or '' }}"></label>
                  </div>
                  <div class="grid">
                    <label>–ü–æ–ª <input name="sex" value="{{ c.sex or '' }}"></label>
                  </div>
                  <label>–ó–∞–º–µ—Ç–∫–∏ <textarea name="notes" rows="2">{{ c.notes or '' }}</textarea></label>

                  <div class="actions-row" style="margin-top:8px">
                    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="secondary" type="submit" formmethod="post" formaction="/children/{{ c.id }}/delete" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å?')">–£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                </form>
              </div>
            </details>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="card muted">–î–µ—Ç–µ–π –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏.</div>
    {% endif %}
  </section>
</div>
</body>
</html>
